# 로그인 후 브라우저 쿠키에 userinfo가 저장되어 있는 문제 해결

## 문제 상황

사용자 팔로우(혹은 팔로워) 목록을 조회하는 엔드포인트(`api/users/1/followings`)에 접근하면 다음과 같이 해당하는 사용자들의 배열 `User[]` 형태로 반환되기를 원한다.

```json
[
        {
            "createdAt": "2025-07-31T03:50:04.136Z",
            "updatedAt": "2025-07-31T03:50:04.136Z",
            "deletedAt": null,
            "id": 2,
            "email": "dotu.standard@gmail.com",
            "name": "DOTU",
            "nickname": "dotu.standard",
            "role": "user",
            "profilePicture": "https://lh3.googleusercontent.com/a/ACg8ocJIO23-xTU26chV7V7VPy6KOn6UVfQmVame1W5MZoqcVUYfza4=s96-c",
            "isActive": true
        },
        {
            "createdAt": "2025-07-31T07:48:18.481Z",
            "updatedAt": "2025-07-31T07:48:18.481Z",
            "deletedAt": null,
            "id": 3,
            "email": "big1072005@gmail.com",
            "name": "쇼 빅",
            "nickname": "big1072005",
            "role": "user",
            "profilePicture": "https://lh3.googleusercontent.com/a/ACg8ocLp5kupL1BhxqorgQRgvHHk_r72EjZdIdydgylX_Q67PP3u2kU=s96-c",
            "isActive": true
        }
    ],
```

이는 `1`번 유저의 팔로잉 리스트이다. 팔로잉/팔로워 리스트를 가져올 때 주의해야 할 점은 다음과 같다:

1. 삭제되거나 비활성화는 리스트에 포함될 수 없다.
2. 조회 대상(이 예시에서는 `1`)이 삭제된 사용자이거나 비활성화라면 조회조차 할 수 없다.

위와 같은 이유로 아래와 같이 쿼리문을 작성하였다.

```ts
/** Find user with Followings */
async findWithFollowingsById(id: number): Promise<User | null> {
  return await this.userRepository
    .createQueryBuilder('user')
    .leftJoinAndSelect('user.followings', 'follow')
    .leftJoinAndSelect('follow.following', 'followingUser')
    .where('user.id = :id', { id })
    .andWhere('user.deletedAt IS NULL AND user.isActive = true')
    .andWhere(
      'followingUser.deletedAt IS NULL AND followingUser.isActive = true'
    )
    .getOne();
}
```

하지만 여기에 한 가지 문제점이 존재한다. 예를들어, `id=5`인 사용자가 아무도 팔로우를 하지 않았다고 가정하자. 이때 해당 사용자의 팔로잉 목록을 조회하게 되면 위 쿼리문으로 null 값을 받게 되어 user 자체를 조회할 수 없다고 응답한다.

## 문제 해결

우리는 목록에 아무런 사용자가 없더라도 빈배열을 반환하기를 원한다. 따라서 DAO 코드는 위와 같이 유지하되 서비스 부분에서 예외처리를 하는 것으로 채택하였다.

```ts
 /** Get followings of a user */
async getFollowings(userId: number): Promise<User[] | null> {
  // check if the user exists
  await this.userService.getUserById(userId);
  // user will be null, when no followings exist
  const user = await this.userService.findWithFollowingsById(userId);
  if (!user) {
    // so return []
    return [];
  }
  return user.followings.map((f) => f.following);
}
```

위와 같이 코드를 작성하면 조회하려는 유저의 존재 여부부터 팔로잉 목록이 없다면 빈 배열을 반환할 수 있다.
